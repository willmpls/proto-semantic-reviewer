# Proto Semantic Reviewer - Docker Compose Configuration
#
# Quick Start:
#   1. Copy .env.example to .env and configure your API keys
#   2. Start server: docker-compose up proto-reviewer
#   3. Open http://localhost:8000/docs for API documentation
#
# See examples/curl_examples.md for detailed usage examples.

services:
  # Production-ready server
  proto-reviewer:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - path: .env
        required: false
    environment:
      # Set your API key(s) - at least one is required
      # Export these in your shell before running docker-compose
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Optional: force a specific provider (gemini, openai, anthropic)
      - MODEL_PROVIDER=${MODEL_PROVIDER:-}
      # Optional: custom base URLs for API proxies
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - GEMINI_BASE_URL=${GEMINI_BASE_URL:-}
      # Optional: custom CA certificate bundle
      - LLM_CA_BUNDLE=${LLM_CA_BUNDLE:-}
      - OPENAI_CA_BUNDLE=${OPENAI_CA_BUNDLE:-}
      - ANTHROPIC_CA_BUNDLE=${ANTHROPIC_CA_BUNDLE:-}
      - GEMINI_CA_BUNDLE=${GEMINI_CA_BUNDLE:-}
      # Optional: AD group authorization (comma-separated list)
      # When set, requests must include X-AD-Memberships header with matching group
      - ALLOWED_AD_GROUPS=${ALLOWED_AD_GROUPS:-}
      # Optional: custom standards directory (default: /app/standards)
      - STANDARDS_DIR=${STANDARDS_DIR:-}
    volumes:
      # Mount proto files for CLI review commands
      - ./protos:/protos:ro
      - ./examples:/examples:ro
      # Uncomment to use custom standards:
      # - ./my-standards:/app/standards:ro
    command: ["server", "--host", "0.0.0.0", "--port", "8000"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Development server with auto-reload (use --profile dev)
  proto-reviewer-dev:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - path: .env
        required: false
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - MODEL_PROVIDER=${MODEL_PROVIDER:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - GEMINI_BASE_URL=${GEMINI_BASE_URL:-}
      - LLM_CA_BUNDLE=${LLM_CA_BUNDLE:-}
      - OPENAI_CA_BUNDLE=${OPENAI_CA_BUNDLE:-}
      - ANTHROPIC_CA_BUNDLE=${ANTHROPIC_CA_BUNDLE:-}
      - GEMINI_CA_BUNDLE=${GEMINI_CA_BUNDLE:-}
      - ALLOWED_AD_GROUPS=${ALLOWED_AD_GROUPS:-}
      - STANDARDS_DIR=${STANDARDS_DIR:-}
    volumes:
      # Mount source for live reloading during development
      - ./src:/app/src:ro
      - ./standards:/app/standards:ro
      - ./protos:/protos:ro
      - ./examples:/examples:ro
    command: ["sh", "-c", "python3 -m uvicorn src.server:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/src"]
    profiles:
      - dev

  # MCP server for IDE integration (use --profile mcp)
  proto-reviewer-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    env_file:
      - path: .env
        required: false
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - MODEL_PROVIDER=${MODEL_PROVIDER:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - GEMINI_BASE_URL=${GEMINI_BASE_URL:-}
      - LLM_CA_BUNDLE=${LLM_CA_BUNDLE:-}
      - OPENAI_CA_BUNDLE=${OPENAI_CA_BUNDLE:-}
      - ANTHROPIC_CA_BUNDLE=${ANTHROPIC_CA_BUNDLE:-}
      - GEMINI_CA_BUNDLE=${GEMINI_CA_BUNDLE:-}
      - STANDARDS_DIR=${STANDARDS_DIR:-}
    volumes:
      - ./protos:/protos:ro
      - ./examples:/examples:ro
      # Uncomment to use custom standards:
      # - ./my-standards:/app/standards:ro
    command: ["mcp", "--http", "--port", "3000"]
    profiles:
      - mcp

# =============================================================================
# Usage Examples
# =============================================================================
#
# Start the server:
#   export GOOGLE_API_KEY=your-key
#   docker-compose up proto-reviewer
#
# Start with development auto-reload:
#   docker-compose --profile dev up proto-reviewer-dev
#
# Review a proto file via HTTP:
#   curl -X POST http://localhost:8000/review \
#     -H "Content-Type: application/json" \
#     -d '{"proto_content": "syntax = \"proto3\";\nmessage Test { string id = 1; }"}'
#
# Review a proto file via CLI:
#   docker-compose run --rm proto-reviewer review /examples/events/bad_event.proto
#
# List available standards:
#   docker-compose run --rm proto-reviewer list-aips
#   docker-compose run --rm proto-reviewer list-org-standards
#
# Check health:
#   curl http://localhost:8000/health
#
# View API docs:
#   Open http://localhost:8000/docs in your browser
#
# Start MCP server (for IDE integration):
#   docker-compose --profile mcp up proto-reviewer-mcp
#
# With AD authorization enabled:
#   export ALLOWED_AD_GROUPS=team-platform,team-backend
#   docker-compose up proto-reviewer
#   curl -H "X-AD-Memberships: team-platform" http://localhost:8000/health
